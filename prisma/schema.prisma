// Prisma Schema for CV-Arabia
// Production-ready ATS Resume Builder

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// AUTHENTICATION & USERS
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?
  name          String?
  image         String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  // Relations
  accounts      Account[]
  sessions      Session[]
  profile       UserProfile?
  resumes       Resume[]
  jobTargets    JobTarget[]
  applications  JobApplication[]
  exports       Export[]
  subscription  Subscription?
  usageRecords  UsageRecord[]
  tickets       SupportTicket[]
  auditLogs     AuditLog[]        @relation("UserAuditLogs")
    seeraProfiles SeeraProfile[]
    talentProfile TalentProfile?
    recruiterShortlists RecruiterShortlist[]
    recruiterSavedSearches RecruiterSavedSearch[]
    recruiterJobs RecruiterJob[]
  recruiterCreditLedger RecruiterCreditLedger[]
  cvUnlocks CvUnlock[]
  talentProfileViews TalentProfileView[]
  talentProfileDownloads TalentProfileDownload[]
  giftSubscriptionsSent GiftSubscription[] @relation("GiftSubscriptionsSent")
  giftSubscriptionsRedeemed GiftSubscription[] @relation("GiftSubscriptionsRedeemed")
  paymentTransactions PaymentTransaction[]
  interviewSessions InterviewSession[]

  // Two-factor authentication
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  @@index([email])
  @@index([createdAt])
  @@index([role])
  @@index([deletedAt])
  @@index([emailVerified])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum Citizenship {
  SAUDI
  UAE
  QATAR
  BAHRAIN
  KUWAIT
  OMAN
  OTHER
  PREFER_NOT_TO_SAY
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  type       TokenType @default(EMAIL_VERIFICATION)

  @@unique([identifier, token])
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR
}

model UserProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal info
  firstName   String?
  lastName    String?
  phone       String?
  location    String?
  website     String?
  linkedinUrl String?
  citizenship Citizenship?
  
  // Preferences
  language    String   @default("en")
  timezone    String   @default("UTC")
  dateFormat  String   @default("MM/DD/YYYY")
  
  // Notifications
  emailNotifications Boolean @default(true)
  marketingEmails    Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([citizenship])
}

// ==========================================
// RESUMES
// ==========================================

model Resume {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  slug        String?
  targetRole  String?
  description String?
  language    String   @default("en")
  template    String?
  theme       String?
  fontFamily  String?  @default("jakarta")
  isDefault   Boolean  @default(false)
  isPublic    Boolean  @default(false)
  publicSlug  String?  @unique
  expiresAt   DateTime?
  
  // Current version
  currentVersionId String?
  
  // Metadata
  atsScore         Int?
  recruiterScore   Int?
  lastAnalyzedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  // Relations
  versions    ResumeVersion[]
  sections    ResumeSection[]
  exports     Export[]
  jobTargets  JobTargetResume[]
    profilesAsSource SeeraProfile[] @relation("ProfileSourceResume")
    profilesAsCv     SeeraProfile[] @relation("ProfileCvResume")
    talentProfiles   TalentProfile[]
  interviewSessions InterviewSession[]

  @@index([userId])
  @@index([publicSlug])
  @@index([createdAt])
}

// ==========================================
// TALENT POOL (Recruiter Search)
// ==========================================

model TalentProfile {
  id                   String   @id @default(cuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resumeId             String
  resume               Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  displayName          String
  currentTitle         String?
  currentCompany       String?
  location             String?
  yearsExperience      Int?
  skills               String[]
  education            String?
  highestDegreeLevel   DegreeLevel?
  primaryFieldOfStudy  String?
  normalizedFieldOfStudy String?
  graduationYear       Int?
  graduationDate       DateTime?
  experienceBand       ExperienceBand?
  internshipCount      Int?
  projectCount         Int?
  freelanceCount       Int?
  trainingFlag         Boolean?
  summary              String?
  availabilityStatus   String   @default("open_to_offers")
  desiredSalaryMin     Int?
  desiredSalaryMax     Int?

  isVisible            Boolean  @default(true)
  hideCurrentEmployer  Boolean  @default(false)
  hideSalaryHistory    Boolean  @default(true)
  verifiedCompaniesOnly Boolean @default(false)

  noticePeriod         String?
  preferredLocations   String[]
  preferredIndustries  String[]
  desiredRoles         String[]

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  shortlistedBy        RecruiterShortlistCandidate[]
  contact              TalentProfileContact?
  cvUnlocks            CvUnlock[]
  profileViews         TalentProfileView[]
  profileDownloads     TalentProfileDownload[]
  jobRecommendations   RecruiterJobRecommendation[]

  @@index([resumeId])
  @@index([location])
  @@index([availabilityStatus])
  @@index([yearsExperience])
  @@index([highestDegreeLevel])
  @@index([normalizedFieldOfStudy])
  @@index([graduationYear])
  @@index([experienceBand])
  @@index([highestDegreeLevel, normalizedFieldOfStudy])
}

model TalentProfileContact {
  id              String        @id @default(cuid())
  talentProfileId String        @unique
  talentProfile   TalentProfile @relation(fields: [talentProfileId], references: [id], onDelete: Cascade)
  fullName        String?
  email           String?
  phone           String?
  location        String?
  linkedinUrl     String?
  websiteUrl      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([talentProfileId])
}

model RecruiterShortlist {
  id          String   @id @default(cuid())
  recruiterId String
  recruiter   User     @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  name        String
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  candidates  RecruiterShortlistCandidate[]

  @@index([recruiterId])
}

model RecruiterShortlistCandidate {
  id              String        @id @default(cuid())
  shortlistId     String
  shortlist       RecruiterShortlist @relation(fields: [shortlistId], references: [id], onDelete: Cascade)
  talentProfileId String
  talentProfile   TalentProfile @relation(fields: [talentProfileId], references: [id], onDelete: Cascade)
  note            String?
  addedAt         DateTime      @default(now())

  @@unique([shortlistId, talentProfileId])
  @@index([talentProfileId])
}

model RecruiterSavedSearch {
  id          String   @id @default(cuid())
  recruiterId String
  recruiter   User     @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  name        String
  filters     Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([recruiterId])
}

// ==========================================
// RECRUITER JOBS & MATCHING
// ==========================================

model RecruiterJob {
  id             String                @id @default(cuid())
  recruiterId    String
  recruiter      User                  @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  orgId          String?
  title          String
  location       String?
  remoteAllowed  Boolean               @default(false)
  employmentType String?
  seniority      String?
  salaryMin      Int?
  salaryMax      Int?
  jdText         String                @db.Text
  status         RecruiterJobStatus    @default(DRAFT)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  analyses        RecruiterJobAnalysis[]
  recommendations RecruiterJobRecommendation[]

  @@index([recruiterId])
  @@index([status])
  @@index([createdAt])
}

enum RecruiterJobStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum DegreeLevel {
  DIPLOMA
  BACHELOR
  MASTER
  PHD
}

enum ExperienceBand {
  STUDENT_FRESH
  JUNIOR
  MID
  SENIOR
}

model RecruiterJobAnalysis {
  id               String     @id @default(cuid())
  jobId            String
  job              RecruiterJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  mustHaveSkills   String[]
  niceToHaveSkills String[]
  roleKeywords     String[]
  yearsExpMin      Int?
  yearsExpMax      Int?
  languages        String[]
  responsibilities String[]
  redFlags         String[]
  summary          String?    @db.Text
  requiredDegreeLevel DegreeLevel?
  preferredDegreeLevels DegreeLevel[] @default([])
  requiredFieldsOfStudy String[] @default([])
  preferredFieldsOfStudy String[] @default([])
  weights          Json?
  modelInfo        Json?
  createdAt        DateTime   @default(now())

  recommendations RecruiterJobRecommendation[]

  @@index([jobId])
  @@index([createdAt])
}

model RecruiterJobRecommendation {
  id           String     @id @default(cuid())
  jobId        String
  job          RecruiterJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  analysisId   String
  analysis     RecruiterJobAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  candidateId  String
  candidate    TalentProfile @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  rank         Int
  matchScore   Int
  reasons      Json
  gaps         Json
  isPriority   Boolean    @default(false)
  createdAt    DateTime   @default(now())

  @@unique([jobId, candidateId])
  @@index([jobId])
  @@index([analysisId])
  @@index([candidateId])
}

// ==========================================
// RECRUITER CREDITS & UNLOCKS
// ==========================================

model RecruiterCreditLedger {
  id                   String              @id @default(cuid())
  recruiterId          String
  recruiter            User                @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  type                 RecruiterCreditType
  amount               Int
  subscriptionId       String?
  subscription         Subscription?       @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  paymentTransactionId String?
  paymentTransaction   PaymentTransaction? @relation(fields: [paymentTransactionId], references: [id], onDelete: SetNull)
  cvUnlockId           String?             @unique
  cvUnlock             CvUnlock?           @relation(fields: [cvUnlockId], references: [id], onDelete: SetNull)
  reference            String?
  metadata             Json?
  createdAt            DateTime            @default(now())

  @@index([recruiterId])
  @@index([type])
  @@index([createdAt])
  @@unique([type, reference])
}

enum RecruiterCreditType {
  PERIOD_GRANT
  PURCHASE
  SPEND_UNLOCK
  ADJUSTMENT
}

model CvUnlock {
  id          String        @id @default(cuid())
  recruiterId String
  recruiter   User          @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  candidateId String
  candidate   TalentProfile @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())
  creditLedger RecruiterCreditLedger?

  @@unique([recruiterId, candidateId])
  @@index([candidateId])
}

model TalentProfileView {
  id          String        @id @default(cuid())
  recruiterId String
  recruiter   User          @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  candidateId String
  candidate   TalentProfile @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())

  @@unique([recruiterId, candidateId])
  @@index([candidateId])
  @@index([recruiterId])
}

model TalentProfileDownload {
  id          String        @id @default(cuid())
  recruiterId String
  recruiter   User          @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  candidateId String
  candidate   TalentProfile @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())

  @@unique([recruiterId, candidateId])
  @@index([candidateId])
  @@index([recruiterId])
}

model ResumeVersion {
  id        String   @id @default(cuid())
  resumeId  String
  resume    Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  
  version   Int
  name      String?
  snapshot  Json     // Full resume data snapshot
  changeLog String?
  
  createdAt DateTime @default(now())
  
  @@unique([resumeId, version])
  @@index([resumeId])
}

model ResumeSection {
  id        String      @id @default(cuid())
  resumeId  String
  resume    Resume      @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  
  type      SectionType
  title     String      // Customizable title
  order     Int
  isVisible Boolean     @default(true)
  content   Json        // Section-specific content
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  @@index([resumeId])
  @@index([type])
}

enum SectionType {
  CONTACT
  SUMMARY
  EXPERIENCE
  EDUCATION
  SKILLS
  PROJECTS
  CERTIFICATIONS
  AWARDS
  PUBLICATIONS
  VOLUNTEERING
  LANGUAGES
  REFERENCES
  CUSTOM
}

// ==========================================
// JOB TARGETING
// ==========================================

model JobTarget {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  company     String?
  description String?  @db.Text
  url         String?
  
  // Extracted data
  extractedSkills    Json?
  extractedRequirements Json?
  keywords           String[]
  
  // Match analysis
  matchScore    Int?
  analysisData  Json?
  analyzedAt    DateTime?
  
  // Generated content
  tailoredSummary    String? @db.Text
  coverLetter        String? @db.Text
  linkedinSummary    String? @db.Text
  recruiterEmail     String? @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  resumes     JobTargetResume[]
  application JobApplication?
  
  @@index([userId])
  @@index([createdAt])
}

model JobTargetResume {
  id          String    @id @default(cuid())
  jobTargetId String
  jobTarget   JobTarget @relation(fields: [jobTargetId], references: [id], onDelete: Cascade)
  resumeId    String
  resume      Resume    @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  
  // Tailored version
  tailoredContent Json?
  matchScore      Int?
  
  createdAt DateTime @default(now())
  
  @@unique([jobTargetId, resumeId])
}

// ==========================================
// JOB APPLICATIONS TRACKER
// ==========================================

model JobApplication {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Job info
  jobTitle    String
  company     String
  location    String?
  salary      String?
  url         String?
  
  // Application details
  status      ApplicationStatus @default(SAVED)
  appliedAt   DateTime?
  source      String?           // Where you found the job
  
  // Related job target
  jobTargetId String?  @unique
  jobTarget   JobTarget? @relation(fields: [jobTargetId], references: [id])
  
  // Tracking
  followUpDate DateTime?
  responseDate DateTime?
  interviewDate DateTime?
  
  // Notes and contacts
  notes       ApplicationNote[]
  contacts    Contact[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([appliedAt])
}

enum ApplicationStatus {
  SAVED
  APPLIED
  SCREENING
  INTERVIEW
  OFFER
  ACCEPTED
  REJECTED
  WITHDRAWN
}

model ApplicationNote {
  id            String         @id @default(cuid())
  applicationId String
  application   JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  content       String @db.Text
  type          NoteType @default(GENERAL)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([applicationId])
}

enum NoteType {
  GENERAL
  INTERVIEW
  FOLLOW_UP
  FEEDBACK
  RESEARCH
}

model Contact {
  id            String         @id @default(cuid())
  applicationId String
  application   JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  name          String
  title         String?
  email         String?
  phone         String?
  linkedinUrl   String?
  notes         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([applicationId])
}

// ==========================================
// EXPORTS & SHARING
// ==========================================

model Export {
  id        String       @id @default(cuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  resumeId  String
  resume    Resume       @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  
  format    ExportFormat
  template  String
  fileName  String
  fileUrl   String?
  fileSize  Int?
  
  // Export options
  options   Json?
  
  createdAt DateTime @default(now())
  expiresAt DateTime?
  
  @@index([userId])
  @@index([resumeId])
}

enum ExportFormat {
  PDF
  DOCX
  TXT
  JSON
}

// ==========================================
// SUBSCRIPTIONS & BILLING
// ==========================================

model Subscription {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan            PlanType @default(FREE)
  status          SubscriptionStatus @default(ACTIVE)

  // Stripe
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  // Billing cycle
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean @default(false)
  recruiterCreditLedger RecruiterCreditLedger[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([plan])
  @@index([currentPeriodEnd])
}

// ==========================================
// INTERVIEW SESSIONS
// ==========================================

model InterviewSession {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resumeId           String?
  resume             Resume?  @relation(fields: [resumeId], references: [id], onDelete: SetNull)

  targetRole         String
  experienceLevel    String
  interviewLang      String
  overallScore       Float
  summary            Json?
  results            Json?
  transcript         Json?

  recordingUrl       String?
  recordingProvider  String?
  recordingBucket    String?
  recordingPath      String?
  recordingMimeType  String?
  recordingDuration  Int?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

model GiftSubscription {
  id                String     @id @default(cuid())
  token             String     @unique
  createdByUserId   String
  createdBy         User       @relation("GiftSubscriptionsSent", fields: [createdByUserId], references: [id], onDelete: Cascade)
  recipientEmail    String?
  message           String?
  plan              PlanType   @default(PRO)
  interval          GiftInterval
  status            GiftStatus @default(PENDING)
  stripeSessionId   String?    @unique
  amountSar         Float?
  expiresAt         DateTime?
  redeemedAt        DateTime?
  redeemedByUserId  String?
  redeemedBy        User?      @relation("GiftSubscriptionsRedeemed", fields: [redeemedByUserId], references: [id], onDelete: SetNull)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  paymentTransactions PaymentTransaction[]

  @@index([createdByUserId])
  @@index([recipientEmail])
  @@index([status])
  @@index([expiresAt])
}

model PaymentTransaction {
  id                     String          @id @default(cuid())
  provider               PaymentProvider @default(TUWAIQPAY)
  status                 PaymentStatus   @default(PENDING)
  purpose                PaymentPurpose

  userId                 String?
  user                   User?           @relation(fields: [userId], references: [id], onDelete: SetNull)

  providerTransactionId  String?         @unique
  providerBillId         String?         @unique
  providerReference      String?
  paymentLink            String?

  amountSar              Float
  currency               String          @default("SAR")
  plan                   PlanType?
  interval               GiftInterval?
  credits                Float?
  recipientEmail         String?
  message                String?
  metadata               Json?
  paidAt                 DateTime?

  giftId                 String?
  giftSubscription       GiftSubscription? @relation(fields: [giftId], references: [id], onDelete: SetNull)
  recruiterCreditLedger  RecruiterCreditLedger[]

  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  @@index([provider])
  @@index([status])
  @@index([purpose])
  @@index([userId])
  @@index([giftId])
}

enum PlanType {
  FREE
  PRO
  GROWTH
  ENTERPRISE
}

enum GiftInterval {
  MONTHLY
  YEARLY
}

enum GiftStatus {
  PENDING
  REDEEMED
  EXPIRED
  CANCELED
}

enum PaymentProvider {
  TUWAIQPAY
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
}

enum PaymentPurpose {
  SUBSCRIPTION
  AI_CREDITS
  RECRUITER_CV_CREDITS
  GIFT
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  TRIALING
}

model UsageRecord {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      UsageType
  count     Int       @default(1)
  credits   Float     @default(0)
  amountSar Float?
  metadata  Json?

  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([userId, type, createdAt])
}

enum UsageType {
  AI_GENERATION
  AI_CREDIT_TOPUP
  EXPORT_PDF
  EXPORT_DOCX
  RESUME_CREATE
  JD_ANALYSIS
}

// ==========================================
// CONTENT MANAGEMENT
// ==========================================

model Template {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  thumbnail   String?
  
  // Template configuration
  config      Json
  styles      String?  @db.Text // CSS
  isActive    Boolean  @default(true)
  isPremium   Boolean  @default(false)
  
  // Stats
  usageCount  Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([isActive])
}

model BlogPost {
  id          String   @id @default(cuid())
  
  title       String
  slug        String   @unique
  excerpt     String?
  content     String   @db.Text
  coverImage  String?
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  // Status
  status      PostStatus @default(DRAFT)
  publishedAt DateTime?
  
  // Author
  authorId    String?
  authorName  String?
  
  // Categorization
  category    String?
  tags        String[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([status])
  @@index([publishedAt])
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model KnowledgeBaseArticle {
  id          String   @id @default(cuid())
  
  title       String
  slug        String   @unique
  content     String   @db.Text
  
  category    String
  order       Int      @default(0)
  isPublished Boolean  @default(true)
  
  // Stats
  helpfulCount    Int @default(0)
  notHelpfulCount Int @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([category])
}

// ==========================================
// SUPPORT
// ==========================================

model SupportTicket {
  id        String       @id @default(cuid())
  userId    String?
  user      User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Ticket info
  subject   String
  message   String       @db.Text
  email     String
  
  status    TicketStatus @default(OPEN)
  priority  TicketPriority @default(MEDIUM)
  category  String?
  
  // Responses
  responses TicketResponse[]
  
  // Tracking
  assignedTo   String?
  resolvedAt   DateTime?
  firstResponseAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model TicketResponse {
  id        String        @id @default(cuid())
  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  message   String        @db.Text
  isStaff   Boolean       @default(false)
  authorId  String?
  authorName String?
  
  createdAt DateTime      @default(now())
  
  @@index([ticketId])
}

// ==========================================
// ADMIN & AUDIT
// ==========================================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  
  enabled     Boolean  @default(false)
  percentage  Int      @default(100) // For gradual rollouts
  
  // Targeting
  enabledFor  String[] // User IDs
  disabledFor String[] // User IDs
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([key])
}

// ==========================================
// RATE LIMITING & SECURITY
// ==========================================

model RateLimitRecord {
  id        String   @id @default(cuid())
  key       String   // IP or user ID
  endpoint  String
  count     Int      @default(1)
  windowStart DateTime

  @@unique([key, endpoint, windowStart])
  @@index([key])
  @@index([windowStart])
}

// ==========================================
// SEERA LINK - PUBLIC PROFILE PAGES
// ==========================================

enum ProfileVisibility {
  PUBLIC
  UNLISTED
  PASSWORD_PROTECTED
}

enum ProfilePersona {
  JOBS
  FREELANCE
  NETWORKING
  CUSTOM
}

enum ProfileTemplate {
  MINIMAL
  BOLD
}

enum ProfileStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CTAType {
  WHATSAPP
  PHONE
  EMAIL
  LINKEDIN
  DOWNLOAD_CV
  VIEW_CV
  CUSTOM
}

enum AnalyticsEventType {
  PAGE_VIEW
  CTA_CLICK
  PDF_DOWNLOAD
}

model SeeraProfile {
  id                String              @id @default(cuid())
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // URL & Identity
  slug              String              @unique
  persona           ProfilePersona      @default(JOBS)
  template          ProfileTemplate     @default(MINIMAL)
  status            ProfileStatus       @default(DRAFT)

  // Privacy
  visibility        ProfileVisibility   @default(PUBLIC)
  accessCode        String?             // Hashed password for protected profiles
  noIndex           Boolean             @default(false)
  hidePhoneNumber   Boolean             @default(false)

  // Hero Section
  displayName       String
  title             String
  location          String?
  bio               String?             @db.Text
  avatarUrl         String?

  // Status Badges (JSON array of strings like "Open to work", "Freelance")
  statusBadges      String[]            @default([])

  // Language & Theme
  language          String              @default("en") // "en" | "ar"
  themeColor        String              @default("sapphire") // Matches resume themes
  customColors      Json?               // Optional custom color overrides

  // Resume Integration
  sourceResumeId    String?             // Resume used to generate this profile
  sourceResume      Resume?             @relation("ProfileSourceResume", fields: [sourceResumeId], references: [id], onDelete: SetNull)

  // CV Settings
  enableDownloadCv  Boolean             @default(false)
  cvFileUrl         String?             // Uploaded PDF URL
  cvResumeId        String?             // Or link to existing resume for PDF generation
  cvResume          Resume?             @relation("ProfileCvResume", fields: [cvResumeId], references: [id], onDelete: SetNull)

  // CTA Customization
  ctaWhatsappNumber String?
  ctaWhatsappMessage String?            @default("Hi! I saw your Seera profile and would like to connect.")
  ctaPhoneNumber    String?
  ctaEmail          String?
  ctaEmailSubject   String?             @default("Let's Connect")
  ctaEmailBody      String?             @db.Text
  ctaLinkedinUrl    String?
  enabledCtas       CTAType[]           @default([WHATSAPP, EMAIL, LINKEDIN])

  // Metadata
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  publishedAt       DateTime?
  deletedAt         DateTime?

  // Relations
  highlights        SeeraProfileHighlight[]
  experiences       SeeraProfileExperience[]
  projects          SeeraProfileProject[]
  certificates      SeeraProfileCertificate[]
  analytics         SeeraProfileAnalytics[]

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@index([visibility])
  @@map("seera_profiles")
}

model SeeraProfileHighlight {
  id            String        @id @default(cuid())
  profileId     String
  profile       SeeraProfile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  content       String        @db.Text // The highlight text with metrics
  icon          String?       // Optional icon identifier (e.g., "trophy", "chart", "users")
  sortOrder     Int           @default(0)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([profileId])
  @@map("seera_profile_highlights")
}

model SeeraProfileExperience {
  id            String        @id @default(cuid())
  profileId     String
  profile       SeeraProfile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  company       String
  role          String
  location      String?
  startDate     String?       // "Jan 2020" format
  endDate       String?       // "Present" or "Dec 2023"
  description   String?       @db.Text
  isFeatured    Boolean       @default(false)
  sortOrder     Int           @default(0)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([profileId])
  @@map("seera_profile_experiences")
}

model SeeraProfileProject {
  id            String        @id @default(cuid())
  profileId     String
  profile       SeeraProfile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  title         String
  description   String?       @db.Text
  url           String?
  imageUrl      String?
  tags          String[]      @default([])
  sortOrder     Int           @default(0)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([profileId])
  @@map("seera_profile_projects")
}

model SeeraProfileCertificate {
  id            String        @id @default(cuid())
  profileId     String
  profile       SeeraProfile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name          String
  issuer        String
  date          String?       // "2023" or "Jan 2023"
  url           String?       // Credential URL
  sortOrder     Int           @default(0)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([profileId])
  @@map("seera_profile_certificates")
}

model SeeraProfileAnalytics {
  id            String              @id @default(cuid())
  profileId     String
  profile       SeeraProfile        @relation(fields: [profileId], references: [id], onDelete: Cascade)

  eventType     AnalyticsEventType
  ctaType       CTAType?            // If event is CTA_CLICK

  // Privacy-friendly tracking
  visitorHash   String              // Hashed IP + User Agent for unique visitor detection
  deviceType    String?             // "desktop" | "mobile" | "tablet"
  referrer      String?             @db.Text
  country       String?             // From IP geolocation (coarse)

  // UTM Tracking
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  utmContent    String?
  utmTerm       String?

  createdAt     DateTime            @default(now())

  @@index([profileId])
  @@index([profileId, eventType])
  @@index([profileId, createdAt])
  @@index([createdAt])
  @@map("seera_profile_analytics")
}

// Slug reservation table for profanity filter and reserved words
model ReservedSlug {
  slug          String    @id
  reason        String    // "reserved" | "profanity" | "trademark"
  createdAt     DateTime  @default(now())

  @@map("reserved_slugs")
}
